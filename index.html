<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Telegram Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-box {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>üîç Telegram Web App Test</h1>
    
    <div id="test-results"></div>
    
    <button onclick="sendTestData()">üì§ Send Test Data to Bot</button>
    <button onclick="showMoreInfo()">‚ÑπÔ∏è Show More Info</button>
    
    <div id="detailed-info" style="display: none;"></div>
    
    <script>
        function addResult(message, type = 'test-box') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            document.getElementById('test-results').appendChild(div);
        }
        
        // Test 1: Check if we're in Telegram
        addResult(`<h3>Test 1: Environment Check</h3>
            <strong>User Agent:</strong> ${navigator.userAgent}<br>
            <strong>Referrer:</strong> ${document.referrer || 'none'}<br>
            <strong>URL:</strong> ${window.location.href}`, 
            navigator.userAgent.includes('Telegram') ? 'test-box success' : 'test-box error');
        
        // Test 2: Check Telegram object
        if (typeof window.Telegram === 'undefined') {
            addResult(`<h3>Test 2: Telegram Object ‚ùå</h3>
                Telegram object not found! Make sure this script is loaded:<br>
                <code>&lt;script src="https://telegram.org/js/telegram-web-app.js"&gt;&lt;/script&gt;</code>`, 'test-box error');
        } else {
            addResult(`<h3>Test 2: Telegram Object ‚úÖ</h3>
                Telegram object found successfully!`, 'test-box success');
        }
        
        // Test 3: Check WebApp
        if (typeof window.Telegram?.WebApp === 'undefined') {
            addResult(`<h3>Test 3: WebApp API ‚ùå</h3>
                WebApp API not available!`, 'test-box error');
        } else {
            const tg = window.Telegram.WebApp;
            
            // Initialize
            try {
                tg.ready();
                tg.expand();
                addResult(`<h3>Test 3: WebApp API ‚úÖ</h3>
                    WebApp initialized successfully!`, 'test-box success');
            } catch (error) {
                addResult(`<h3>Test 3: WebApp API ‚ö†Ô∏è</h3>
                    Error initializing: ${error.message}`, 'test-box warning');
            }
            
            // Test 4: Check platform and data
            const platform = tg.platform || 'unknown';
            const hasInitData = tg.initDataUnsafe && Object.keys(tg.initDataUnsafe).length > 0;
            
            if (platform === 'unknown' || !hasInitData) {
                addResult(`<h3>Test 4: Platform & Data ‚ùå</h3>
                    <strong>Platform:</strong> ${platform}<br>
                    <strong>Has Init Data:</strong> ${hasInitData ? 'Yes' : 'No'}<br>
                    <strong>Problem:</strong> Web app not opened through Telegram bot button!<br>
                    <br>
                    <strong>üîß How to fix:</strong><br>
                    1. Go to Telegram<br>
                    2. Send /test to your bot<br>
                    3. Click the web app button<br>
                    4. Don't open this URL directly in browser!`, 'test-box error');
            } else {
                const userData = tg.initDataUnsafe;
                addResult(`<h3>Test 4: Platform & Data ‚úÖ</h3>
                    <strong>Platform:</strong> ${platform}<br>
                    <strong>User ID:</strong> ${userData.user?.id || 'N/A'}<br>
                    <strong>Bot ID:</strong> ${userData.bot_id || 'N/A'}<br>
                    <strong>Chat ID:</strong> ${userData.chat?.id || 'N/A'}<br>
                    <strong>Username:</strong> ${userData.user?.username || 'N/A'}`, 'test-box success');
            }
            
            // Setup buttons
            tg.MainButton.text = "üì§ Send to Bot";
            tg.MainButton.show();
            tg.MainButton.onClick(() => sendTestData());
            
            tg.BackButton.show();
            tg.BackButton.onClick(() => tg.close());
        }
        
        function sendTestData() {
            if (typeof window.Telegram?.WebApp === 'undefined') {
                alert('‚ùå Telegram WebApp not available!');
                return;
            }
            
            const tg = window.Telegram.WebApp;
            
            const testData = {
                message: "Hello from minimal test!",
                timestamp: new Date().toISOString(),
                test: "connectivity",
                url: window.location.href,
                userAgent: navigator.userAgent.substring(0, 100),
                platform: tg.platform,
                hasInitData: !!(tg.initDataUnsafe && Object.keys(tg.initDataUnsafe).length > 0)
            };
            
            try {
                tg.sendData(JSON.stringify(testData));
                addResult(`<h3>üì§ Data Sent!</h3>
                    Sent: <code>${JSON.stringify(testData, null, 2)}</code><br>
                    <strong>Check your bot console for the received data!</strong>`, 'test-box success');
            } catch (error) {
                addResult(`<h3>üì§ Send Failed ‚ùå</h3>
                    Error: ${error.message}`, 'test-box error');
            }
        }
        
        function showMoreInfo() {
            const detailedDiv = document.getElementById('detailed-info');
            detailedDiv.style.display = detailedDiv.style.display === 'none' ? 'block' : 'none';
            
            if (detailedDiv.style.display === 'block') {
                let info = '<h3>üîç Detailed Information</h3>';
                
                if (window.Telegram?.WebApp) {
                    const tg = window.Telegram.WebApp;
                    info += `
                        <div class="test-box">
                            <strong>Telegram WebApp Properties:</strong><br>
                            Platform: ${tg.platform || 'undefined'}<br>
                            Version: ${tg.version || 'undefined'}<br>
                            Is Expanded: ${tg.isExpanded}<br>
                            View Height: ${tg.viewportHeight}<br>
                            <br>
                            <strong>Raw Init Data:</strong><br>
                            <code>${tg.initData || 'not available'}</code><br>
                            <br>
                            <strong>Parsed Init Data:</strong><br>
                            <code>${JSON.stringify(tg.initDataUnsafe, null, 2)}</code>
                        </div>
                    `;
                } else {
                    info += '<div class="test-box error">Telegram WebApp not available for detailed inspection.</div>';
                }
                
                detailedDiv.innerHTML = info;
            }
        }
    </script>
</body>
</html>
